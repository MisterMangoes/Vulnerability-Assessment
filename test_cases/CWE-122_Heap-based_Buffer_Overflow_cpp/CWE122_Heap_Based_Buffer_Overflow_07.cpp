//CWE122_Heap_Based_Buffer_Overflow__c_CWE805_wchar_t_ncat_61

#include <cstdio>
#include <cstdlib>
#include <cwchar>
#include <cassert>

int dataArraySize = 50;

wchar_t * CWE122_Heap_Based_Buffer_Overflow__c_CWE805_wchar_t_ncat_61b_badSource(wchar_t * data)
{
    /* FLAW: Allocate and point data to a small buffer that is smaller than the large buffer used in the sinks */
    data = (wchar_t *)malloc(dataArraySize*sizeof(wchar_t));
    if (data == NULL) {exit(-1);}
    data[0] = L'\0'; /* null terminate */
    return data;
}

int main()
{
    wchar_t * data;
    data = NULL;
    data = CWE122_Heap_Based_Buffer_Overflow__c_CWE805_wchar_t_ncat_61b_badSource(data);
    {
        wchar_t source[100];
        wmemset(source, L'C', 100-1); /* fill with L'C's */
        source[100-1] = L'\0'; /* null terminate */
        /* POTENTIAL FLAW: Possible buffer overflow if source is larger than sizeof(data)-strlen(data) */
        assert((dataArraySize - wcslen(data)) >= 100);
        wcsncat(data, source, 100);
        wprintf(L"%ls\n", data);
        free(data);
    }
    printf("%s\n", "finished");
    return 0;
}