/*
Program description: In this program, nresp is initialized with the return value of the get_int() function. The get_int() function returns an integer that is read from standard input using fgets(). Then, if nresp is greater than or equal 0 and nresp * sizeof(char*) is greater than or equal to 0, response is allocated with the space of nresp char*'s. Finally, the nresp char*'s in response is assigned as 'a' using a for loop 

Vulnerability and consequence: However, if the nresp is large enough, the integer can wrap around when memory is allocated for response, thus response is allocated to a 0 byte buffer. For example, if nresp equals 1073741824, then response is allocated with 1073741824 * sizeof(char*) bytes, which wraps around to 0 bytes. Therefore, in the following for loop, where the program attempts to assign elements of response with "a", a heap buffer overflow occurs

The vulnerability triggers in the following lines:
for (int i = 0; i < nresp; i++) {
	response[i] = "a";
}

Mitigation: To make this program safe to run, ensure that the storage size of response can hold nresp character pointers. Additionally, the input could be restricted to prevent an integer overflow, which in turn would prevent the heap buffer overflow
*/

#include <stdio.h>
#include <assert.h>

int get_int() {
	int data = -1;
	char inputBuffer[11] = "";
	if (fgets(inputBuffer, 11, stdin) != NULL) {
		data = atoi(inputBuffer); //convert to int
	}
	return data;
}

int main() {    
	int nresp = get_int();
	printf("nresp = %d\n", nresp);
	if (nresp > 0) {
		int responseMemorySize = nresp * sizeof(char*);
		if(responseMemorySize >= 0) {
			printf("nresp * sizeof(char*) = %d\n", nresp * sizeof(char*)); 
			char * response = (char*)malloc(responseMemorySize);
			assert(responseMemorySize/sizeof(char*) >= nresp);
			for (int i = 0; i < nresp; i++) {
				response[i] = 'a';
			}
		}
	}
	return 0;
} 

//Original file: CWE122_Heap_Based_Buffer_Overflow_04

/*
Question: Which of the following is correct? D
a) A stack buffer overflow occurs in the for loop at line 35
b) A stack buffer overflow occurs in the if statement at line 20
c) A heap buffer overflow occurs in the if statement at line 20
d) A heap buffer overflow occurs in the for loop at line 35
*/