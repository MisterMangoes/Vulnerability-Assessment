/*
Program description: In this program, "BadString" is passed as an argument to the function helperBad(). In helperBad(), the pointer reversedString is allocated memory and the string that was passed as the argument to the function is reversed and is stored in the memory location that reversedString points to. reversedString is freed and is returned from the function, which is stored in a character pointer in the main function. The reversed string that was returned from helperBad() is finally printed out 

Vulnerability and consequence: However, in helperBad(), after reversing the string and storing it in the memory location that reversedString points to, reversedString is deallocated with free and the pointer is returned from the function, thus a use after free error occurs

The vulnerability triggers in the following lines:
return reversedString;

Mitigation: To make this program safe to run, ensure that reversedString is only freed after it has been printed out in the main function. Therefore, only free reversedString when there are no more uses for reversedString. To check if reversedString has been freed or not, assign the pointer to NULL after using free, then perform a NULL check
*/

#include <stdlib.h>
#include <assert.h>

static char * helperBad(char * aString) {
	int reversedStringFreed = 0;
	if (aString != NULL) {
		int strLength = strlen(aString);
		char * reversedString = (char *)malloc(strLength + 1);
		for (int i = 0; i < strLength; i++) {
			reversedString[i] = aString[strLength - i - 1];
		}
		reversedString[strLength] = '\0';
		free(reversedString);
		reversedStringFreed = 1;
		assert(!reversedStringFreed);
		return reversedString;
	}
	else {
		return NULL;
	}
}

int main() {
	char * reversedString = NULL;
	reversedString = helperBad("BadSink");
	printf("%s\n", reversedString);
	return 0;
}

//Original file: CWE416_Use_After_Free_05

/*
Question: Which of the following is correct? C
a) A heap buffer overflow occurs in the for loop at line 20
b) A null pointer dereference occurs at line 37
c) A use after free occurs at line 27
d) A heap buffer overflow occurs at line 23
*/