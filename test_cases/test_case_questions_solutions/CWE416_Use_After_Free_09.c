/*
Program description: In this program, the function globalReturnsTrueOrFalse() randomly returns either a 0 or 1. If globalReturnsTrueOrFalse() returns a 1, data is allocated space for a wide character string, which is filled with A's and a null terminate, then data is freed. If memory is allocated for data, globalReturnsTrueOrFalse() is called again and if it returns a 1 again, data is printed out 

Vulnerability and consequence: However, if globalReturnsTrueOrFalse() returns a 1, data is allocated memory then deallocated using free. If globalReturnsTrueOrFalse() returns 1 again, the program attempts to print data, which is already freed, thus causing a use after free error

The vulnerability triggers in the following lines:
wprintf(L"%ls\n", data);

Mitigation: To make this program safe to run, ensure that data is only freed after data could be printed. Therefore, only free data when there are no more uses for data. To check if the data has been freed or not, assign data to NULL after using free, then perform a NULL check
*/

#include <wchar.h>
#include <assert.h>

int globalReturnsTrueOrFalse() {
	srand(time(0)); //use current time as seed
	return (rand() % 2);
}

int main() {
	int dataFreed = 0;
	wchar_t * data = NULL;
	int dataAllocated = 0;
	if(globalReturnsTrueOrFalse()) {
		dataAllocated = 1;
		int dataMemorySize = 100 * sizeof(wchar_t);
		data = (wchar_t *)malloc(dataMemorySize);
		//assert(data != NULL);
		wmemset(data, L'A', 100 - 1);
		//assert(100 - 1 < dataMemorySize/sizeof(wchar_t));
		data[100 - 1] = L'\0';
		free(data);
		dataFreed = 1;
	}
	if(dataAllocated && globalReturnsTrueOrFalse()) {
		//assert(data != NULL);
		//assert(!dataFreed);
		wprintf(L"%ls\n", data);
	}
	return 0;
}

//Original file: CWE416_Use_After_Free_09

/*
Question: Which of the following is correct? A
a) To catch this bug, the assertion at line 37 should be added
b) To catch this bug, the assertion at line 28 should be added
c) To catch this bug, the assertion at line 36 should be added
d) To catch this bug, the assertion at line 30 should be added
*/