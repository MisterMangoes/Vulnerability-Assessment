/*
Program description: In this program, data is allocated memory for 100 wide characters, which is filled with A's and the last wide character is assigned to a terminating character. Then, the badSink() function is called, which initializes a wide character array of size 50, dest. Then, data is appended to dest with wcscat()

Vulnerability and consequence: However, when using wcscat(), the program does not check the storage size for dest or how much space has already been used by dest. dest has a storage size for 50 wide characters but data consists of 100 wide characters. Therfore, the program overwrites dest incorrectly when data is appended to dest, which causes a stack buffer overflow

The vulnerability triggers in the following lines:
wcscat(dest, data);

Mitigation: To make this program safe to run, ensure that the number of wide characters in data is equal to or less than the remaining space for wide characters in dest when using wcscat() so that the function does not overwrite adjacent memory
*/

#include <wchar.h>
#include <assert.h>

#define ALLOCA alloca

static wchar_t * badData = NULL;

int dataArraySize = 100;

static void badSink() {
	wchar_t * data = badData;
	wchar_t dest[50] = L"";
	//assert(sizeof(dest) <= sizeof(data));
	//assert(dataArraySize <= ((sizeof(dest)/sizeof(dest[0])) - wcslen(dest)));
	wcscat(dest, data);
}

int main() {
	wchar_t * data = (wchar_t *)ALLOCA(dataArraySize * sizeof(wchar_t));
	//assert(dataArraySize - 1 <= (sizeof(data)/sizeof(data[0])));
	wmemset(data, L'A', dataArraySize - 1);
	//assert(dataArraySize - 1 <= (sizeof(data)/sizeof(data[0])));
	data[dataArraySize - 1] = L'\0';
	badData = data;
	badSink();
	return 0;
}

//Original file: CWE121_Stack_Based_Buffer_Overflow_07

/*
Question: Which of the following is correct? D
a) To catch this bug, the assertion at line 31 should be added
b) To catch this bug, the assertion at line 33 should be added
c) To catch this bug, the assertion at line 24 should be added
d) To catch this bug, the assertion at line 25 should be added
*/