/*
Program description: In this program, a string of 4 characters, inputBuffer is initialized. For each 'h' character in inputBuffer, it is exanded to "hello" and result of the string expansion is stored in the memory location pointed by the character pointer, dst_buf. The memory location pointed by dst_buf is freed and is printed out

Vulnerability and consequence: However, after dst_buf is deallocated with free, the program prints out the string that is stored in memory location pointed to by dst_buf, which causes a use after free error

The vulnerability triggers in the following lines:
printf("%s\n", dst_buf);

Mitigation: To make this program safe to run, ensure that dst_buf is only freed after it has been printed out. Therefore, only free dst_buf when there are no more uses for data. To check if the dst_buf has been freed or not, assign dst_buf to NULL after using free, then perform a NULL check
*/

#include <stdlib.h>
#include <assert.h>

int main()  {
	int dst_bufFreed = 0;
	char inputBuffer[] = "hhhi";
	char * dst_buf = NULL;
	dst_buf = (char*)malloc(5 * sizeof(char) * strlen(inputBuffer));
	int dst_index = 0;
	for (int i = 0; i < strlen(inputBuffer) + 1; i++) {
		if('h' == inputBuffer[i] ) {
			dst_buf[dst_index++] = 'h';
			dst_buf[dst_index++] = 'e';
			dst_buf[dst_index++] = 'l';
			dst_buf[dst_index++] = 'l';
			dst_buf[dst_index++] = 'o';
		}
		else {
			dst_buf[dst_index++] = inputBuffer[i];
		}
	}
	free(dst_buf);
	dst_bufFreed = 1;
	assert(!dst_bufFreed);
	printf("%s\n", dst_buf);
	return 0;
}

//Original file: CWE416_Use_After_Free_03

/*
Question: Which of the following is NOT correct? B
a) The code has a use after free at line 33
b) The code has a heap buffer overflow in the for loop at line 21 because the string expansion overruns the space of the buffer 
c) The index for dst_buf in the for loop at line 21 does not cause a heap buffer overflow because it does not exceed the upper bound of the buffer
d) sizeof(char) should be used when allocating memory for dst_buf at line 19
*/